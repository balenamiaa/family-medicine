// Prisma schema for MedCram Study App
// Supports polymorphic study cards with spaced repetition

generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// User model for authentication (can be extended with providers later)
model User {
  id        String   @id @default(cuid())
  email     String?  @unique
  name      String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  studySets     StudySet[]
  cardProgress  CardProgress[]
  reviewHistory ReviewHistory[]

  @@map("users")
}

// Study sets contain collections of study cards
model StudySet {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  title       String
  description String?
  tags        String[] @default([])
  isPublic    Boolean  @default(false) @map("is_public")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  user  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  cards StudyCard[]

  @@index([userId])
  @@map("study_sets")
}

// Polymorphic study card model using JSONB for type-specific content
model StudyCard {
  id         String     @id @default(cuid())
  studySetId String     @map("study_set_id")
  cardType   CardType   @map("card_type")
  content    Json       // Type-specific content stored as JSONB
  difficulty Difficulty @default(MEDIUM)
  tags       String[]   @default([])
  orderIndex Int        @default(0) @map("order_index")
  createdAt  DateTime   @default(now()) @map("created_at")
  updatedAt  DateTime   @updatedAt @map("updated_at")

  // Relations
  studySet      StudySet        @relation(fields: [studySetId], references: [id], onDelete: Cascade)
  cardProgress  CardProgress[]
  reviewHistory ReviewHistory[]

  @@index([studySetId])
  @@index([cardType])
  @@map("study_cards")
}

// Spaced repetition progress per user per card
model CardProgress {
  id              String    @id @default(cuid())
  userId          String    @map("user_id")
  cardId          String    @map("card_id")
  easeFactor      Float     @default(2.5) @map("ease_factor")
  intervalDays    Int       @default(0) @map("interval_days")
  repetitions     Int       @default(0)
  nextReviewDate  DateTime  @default(now()) @map("next_review_date")
  lastReviewedAt  DateTime? @map("last_reviewed_at")
  totalReviews    Int       @default(0) @map("total_reviews")
  correctReviews  Int       @default(0) @map("correct_reviews")
  avgResponseTime Float?    @map("avg_response_time_ms")

  // Relations
  user User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  card StudyCard @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@unique([userId, cardId])
  @@index([userId, nextReviewDate])
  @@map("card_progress")
}

// Review history for analytics
model ReviewHistory {
  id             String   @id @default(cuid())
  userId         String   @map("user_id")
  cardId         String   @map("card_id")
  quality        Int      // SM-2 quality rating 0-5
  correct        Boolean
  responseTimeMs Int?     @map("response_time_ms")
  reviewedAt     DateTime @default(now()) @map("reviewed_at")

  // Relations
  user User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  card StudyCard @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@index([userId, reviewedAt])
  @@index([cardId])
  @@map("review_history")
}

// Enum for card types
enum CardType {
  NOTE        // Markdown notes for reading/recall
  MCQ_SINGLE  // Multiple choice, single answer
  MCQ_MULTI   // Multiple choice, multiple answers
  TRUE_FALSE  // True/False statements
  SBA         // Single Best Answer (clinical vignettes)
  CLOZE       // Fill in the blanks
  EMQ         // Extended Matching Questions
  WRITTEN     // Free-form written answer

  @@map("card_type")
}

// Enum for difficulty levels
enum Difficulty {
  EASY
  MEDIUM
  HARD

  @@map("difficulty")
}
